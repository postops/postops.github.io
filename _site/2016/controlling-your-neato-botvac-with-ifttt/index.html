<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Controlling your Neato Botvac with IFTTT - Part 1</title>
  <meta name="description" content="cat /dev/random > blog">
  <meta name="author" content="Jay Wallace">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Controlling your Neato Botvac with IFTTT - Part 1">
  <meta name="twitter:description" content="Keeping the cat off the couch with a bit of Terraform, Packer, and IFTTT magic">
  <meta name="twitter:image" content="http://www.postops.co/images/posts/botvac-post/this-has-gotta-stop.jpg" />

  <meta property="og:type" content="article">
  <meta property="og:title" content="Controlling your Neato Botvac with IFTTT - Part 1">
  <meta property="og:description" content="Keeping the cat off the couch with a bit of Terraform, Packer, and IFTTT magic">
  <meta property="og:image" content="http://www.postops.co/images/posts/botvac-post/this-has-gotta-stop.jpg" />

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="///2016/controlling-your-neato-botvac-with-ifttt/">
  <link rel="alternate" type="application/rss+xml" title="postops" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of postops">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">postops</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">cat /dev/random > blog</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to postops blog" class="blog-button">Blog</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/mootpt" title="@mootpt on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
            <!-- Medium -->
            <li class="navigation__item">
              <a href="https://medium.com/@postops" title="postops on Medium" target="_blank">
                <i class="icon icon-social-medium"></i>
                <span class="label">Medium</span>
              </a>
            </li>
          

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/cantc" title="cantc on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/mootpt" title="mootpt on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            

            
              <!-- Email -->
              <li class="navigation__item">
                <a href="https://keybase.io/nullpt" title="nullpt on Keybase" target="_blank">
                  <i class="icon icon-key"></i>
                  <span class="label">Keybase</span>
                </a>
              </li>
            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="25 Jun 2016" class="post-meta__date date">25 Jun 2016</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#terraform">terraform</a> <a href="/tags/#packer">packer</a> <a href="/tags/#api">api</a> <a href="/tags/#iot">iot</a> <a href="/tags/#botvac">botvac</a> <a href="/tags/#cats">cats</a> </span>
    </div>
    <h1 class="post-title">Controlling your Neato Botvac with IFTTT - Part 1</h1>
  </header>

  <section class="post">
    <p>Natalie and I just recently moved into a new home and rather than move everything we decided it was about time to just up and replace most of our furniture. Along with some of the new furniture purchased, we agreed that we should invest in technology that would help automate our lives. It was quickly determined, that we both hate vacuuming. It doesn’t take long for your floors to be covered in loose hair when you live with two cats and a dog, so we headed out to buy a robot vacuum the second day of living in the new home.</p>

<h3 id="the-purchase">The purchase</h3>
<p>After lots of discussion and comparing products, we decided to go with the <a href="https://amzn.com/B0168KHVZW">Neato Botvac</a>. We chose the Neato mostly because of it’s square design (it needed to reach corners), price point, and vacuuming power. We took it home, unboxed it, and got it all setup on our network.</p>

<p><img src="/images/posts/botvac-post/botvac.jpg" alt="The Neato" /></p>

<p>It was beautiful. No more vacuuming. Well.. No more daily vacuuming. A serious vacuuming is due from time to time. I was excited to say the least. We even gave the vacuum the fitting name of “Jarvis”. I am not a big Iron Man fan, but it felt fitting as this thing was going to be about as transformative as Tony Stark’s AI companion.</p>

<p><img src="/images/posts/botvac-post/real-jarvis.jpg" alt="The real Jarvis" /></p>

<h3 id="one-week-in">One week in</h3>
<p>Jarvis was doing his job of keeping our home clean and the whole process began to feel a bit routine. Jarvis would fire up at 10 AM every morning, scare all the animals into my office, and leave the floors hair free after about an hour or so of work. I began to feel a bit bored with Jarvis and it started to feel as if Jarvis wasn’t really living up to his name. Great. Vacuum runs at 10 AM, cleans floors, and goes to sleep. Surely Jarvis’ life was meant for more greatness than this. I started looking around the house for potential problems Jarvis could solve. Bring me coffee? Yeah that wouldn’t work. Any idea I came up with seemed super impractical and novel at best. Little did I know the problem was staring me straight in the face for several years.</p>

<h3 id="the-perpetrator">The Perpetrator</h3>
<p><img src="/images/posts/botvac-post/the-perpetrator.jpg" alt="Roly Poly" />
This is my cat, Roly Poly. Roly Poly hasn’t always had the easy life. I found her on the streets several years back in Oklahoma City. Once we met, she immediately adopted me. She followed me pretty much everywhere and it wasn’t long before she decided to move into my place. Poly is a sweet cat, don’t get me wrong, but one of her favorite things to do is destroy stuff. Among the things she enjoys destroying, couches definitely top the list. This was one of the main reasons, Natalie and I, decided to get new furniture when moving. Previously we stuck with cheaper couches from IKEA, as we knew Poly was going to tear it up in due time. When we moved into our first house, we went out and made a significant investment on a couch and made a pack that we would keep the animals away from the furniture.</p>

<p>It wasn’t long before Poly noticed the couch.</p>

<p><img src="/images/posts/botvac-post/this-has-gotta-stop.jpg" alt="Poly laying on our new couch" /></p>

<h3 id="this-had-to-stop">This had to stop</h3>
<p>I was determined to make sure Poly would not destroy the couch. I would pick her up and move her off every time she hopped on, tell her no when I saw her pulling her self across the floor anchored into the couch, and the whole thing began to get exhausting. Plus I could only keep an eye on her during my waking hours. At night, she had free reign with the couch, while we slept trying not to think about it.</p>

<p>Then it hit me! The animals hated Jarvis. Ever since we purchased Jarvis, the animals would run into the other room every time 10 AM rolled around and they heard him revving up his motor. Robots and cats do not exactly live in harmony. I decided to use this to my advantage and set out to use Jarvis to keep Poly off the couch.</p>

<h3 id="the-problem">The problem</h3>
<p>Out of the box, Neato Botvacs are only controllable via a smart phone or using some pre-defined schedule. Lame. I did some search, surely thinking this thing has some sort of publicly documented API. Sadly, it did not. If I was going to automate this thing, I knew the first thing I needed to be able to do, was control this thing outside of the app that Neato provided. While the Neato app is great for performing on-demand actions and scheduling, it provides pretty limited functionality outside of that:</p>

<p><img src="/images/posts/botvac-post/neato-screenshot.png" alt="Neato App" /></p>

<p>I knew there had to be a way to control this thing outside of the app and headed over to Github for some quick searching. Low and behold, someone figured it out. I stumbled up <a href="https://github.com/kangguru/botvac">kangguru/botvac</a>, an “unofficial” API client for interacting with the Neato botvac. Awesome sauce! Essentially, this client, forwarded requests to Neato’s secret/undocumented API at <a href="https://nucleo.neatocloud.com">https://nucleo.neatocloud.com</a> using the proper <a href="https://github.com/kangguru/botvac/blob/master/cert/neatocloud.com.crt">certificate</a> and your Botvac’s Serial and Secret collected from <a href="https://beehive.neatocloud.com/">https://beehive.neatocloud.com/</a> after authentication. For more information on how this works, I highly suggest digging through the repository yourself and taking a look. Thank you kangguru for reverse engineering this, so I didn’t have to.</p>

<h3 id="getting-the-serial-and-secret">Getting the Serial and Secret</h3>
<p>Following along with the repo’s README, the first step was getting my Botvac’s serial and secret. This was pretty straight-forward. First I installed the <code class="highlighter-rouge">botvac</code> gem and used <code class="highlighter-rouge">botvac robots</code> from the CLI to get the serial and secret. The email and password used is the same I used when setting up my Neato Botvac for the first time.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> gem install botvac
<span class="gp">$</span> botvac robots
<span class="go">
Email: EmailHere
Password: OnlyYouKnowThis

</span><span class="gp">Robot (BotVacConnected) =&gt;</span> Serial: OPSXXXX-XXXXX Secret: XXXXXXXX</code></pre></figure>

<p>It’s important to make note of both the Serial and Secret.</p>

<h3 id="running-locally-nah">Running Locally? Nah.</h3>
<p>So at this point, I could run the web server locally and make API requests simply by hitting localhost, but I’d rather deploy it somewhere. This API needs to be publicly accessible for a number of reasons I will point out later. It’s worth noting, that using the setup I will go over, one essentially exposes the Botvac to any one who has the URL of the API.</p>

<p>For those who want to run locally, it’s just as easy as Cloning the repo, setting some env variables, starting the webserver, and making requests.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> git clone git@github.com:kangguru/botvac.git
<span class="gp">$</span> <span class="nb">cd </span>botvac
<span class="gp">$</span> <span class="nb">export </span><span class="nv">SERIAL</span><span class="o">=</span>OPSXXXX-XXXXX
<span class="gp">$</span> <span class="nb">export </span><span class="nv">SECRET</span><span class="o">=</span>XXXXXXXX
<span class="gp">$</span> rackup <span class="nt">-r</span> <span class="s1">'botvac/web'</span> <span class="nt">-b</span> <span class="s2">"run Botvac::Web.new"</span>
<span class="gp">$</span> curl http://localhost:9292/get_robot_state</code></pre></figure>

<p>This was sufficient enough for working locally, but I opted to deploy to AWS.</p>

<h3 id="taking-a-look-at-my-deployment">Taking a look at my deployment</h3>
<p>I decided to use Packer and Terraform to deploy my API to AWS. I will review each component in a bit more detail, but here’s a quick overview of how the project is laid out:</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">├── packer
│   ├── jarvis.json
│   └── scripts
│       └── installer.sh
├── shared
│   ├── generate_key_pair.sh
│   ├── main.tf
│   └── ssh_keys
│       ├── jarvis.pem
│       └── jarvis.pub
└── terraform
    ├── firewalls.tf
    ├── instances.tf
    ├── keypairs.tf
    ├── main.tf
    └── networks.tf</code></pre></figure>

<p>The repo in it’s entirety is available at <a href="https://github.com/mootpt/jarvis">mootpt/jarvis</a></p>

<h3 id="packer">Packer</h3>
<p>Let’s first take a look at my <a href="https://github.com/mootpt/jarvis/blob/master/packer/jarvis.json">Packer template</a>. If you are not familiar with Packer, I highly recommend checking out the <a href="https://www.packer.io/">tool</a>. Essentially, I use Packer to build the AMI that’s used for my Botvac infrastructure. It’s pretty straightforward for the most part, but I will take the time to walk through each block and the associated scripts.</p>

<p>The variables block:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"variables"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="s2">"aws_access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_ACCESS_KEY_ID`}}"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"aws_secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_SECRET_ACCESS_KEY`}}"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>In the above code snippit, I have specified that there are a few variables that are important to my build. These variables will be pulled from my local environment variables and used throughout my build template. <code class="highlighter-rouge">AWS_ACCESS_KEY_ID</code> and <code class="highlighter-rouge">AWS_SECRET_ACCESS_KEY</code> are used to access my AWS account to build and store the AMI.</p>

<p>I then set these environment variables:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> <span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>AKIAIOSFODNN7EXAMPLE
<span class="gp">$</span> <span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</code></pre></figure>

<p>The builders block:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"builders"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
  </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amazon-ebs"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_access_key`}}"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_secret_key`}}"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"source_ami"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ami-e0efab88"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"instance_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t2.micro"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ssh_username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ami_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jarvis {{timestamp}}"</span><span class="w">
</span><span class="p">}]</span></code></pre></figure>

<p>In the above snippit, I have specified the <code class="highlighter-rouge">type</code> of builder I want to use for creating my AMI, <code class="highlighter-rouge">amazon-ebs</code>. The AWS builder requires both a <code class="highlighter-rouge">access_key</code> and <code class="highlighter-rouge">secret_key</code>, which I am populating using the variables from the variables block. I have specified the <code class="highlighter-rouge">region</code> for my build, <code class="highlighter-rouge">us-east-1</code>, the <code class="highlighter-rouge">source_ami</code> I wish to start with (<em>note: ami-e0efab88 is pretty much a vanilla Debian Wheezy image</em>), the <code class="highlighter-rouge">instance_type</code> or size I wish to use for my build, <code class="highlighter-rouge">t2.micro</code>. I have also passed in the <code class="highlighter-rouge">ssh_username</code> for the box and provided an <code class="highlighter-rouge">ami_name</code> for reference (<em>note: this is not the AMI name I use in Terraform</em>).</p>

<p>The provisioners block:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"provisioners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scripts/installer.sh"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<p>In the above, I essentially tell the machine I want to run a shell script on the builder. The shell script is as follows:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">sudo </span>apt-get <span class="nt">-y</span> update
<span class="nb">sudo </span>apt-get install <span class="nt">-y</span> ruby rubygems rails
<span class="nb">sudo </span>gem install botvac</code></pre></figure>

<p>Essentially the script installs the <code class="highlighter-rouge">botvac</code> gem and any necessary dependencies.</p>

<p>All that was left was for me to download Packer and build my template. Packer can be downloaded from the <a href="https://www.packer.io/downloads.html">Packer Downloads Page</a> and added to your path. Once downloaded and added to my path, all that was left was to build the template.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> packer build jarvis.json</code></pre></figure>

<script type="text/javascript" src="https://asciinema.org/a/86rsn9i5rp4qtseu6s414d61y.js" id="asciicast-86rsn9i5rp4qtseu6s414d61y" async=""></script>

<p>With the brand new AMI built and stored, I was one step closer to keeping the cat off the couch. Join me next time, when I build some infrastructure using <a href="https://www.terraform.io">Terraform</a> with my newly created AMI. I will then conclude this three part series with IFTTT magic and the end results.</p>

    <a href="https://github.com/postops/postops.github.io/tree/master/_posts/2016-06-25-controlling-your-neato-botvac-with-ifttt.markdown" target="_blank">See a mistake? Open a PR.</a>
  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'postops'; // required: replace example with your forum shortname
        var disqus_config = function () {
          this.page.url = 'http://postops.co/2016/controlling-your-neato-botvac-with-ifttt/';
          this.page.identifier = '/2016/controlling-your-neato-botvac-with-ifttt';
          this.page.title = 'Controlling your Neato Botvac with IFTTT - Part 1';
        };
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2017 Jay Wallace. All rights reserved.</span>
</footer> 

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>


    </div>
  </body>
</html>
